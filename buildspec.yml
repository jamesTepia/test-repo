version: 0.2

env:
  variables:    
    GIT_USER: "jamesTepia"
    GIT_REPO: "test-repo"    
    AWS_DEFAULT_REGION: "us-east-1"
  secrets-manager:
    GIT_TOKEN: "arn:aws:secretsmanager:us-east-1:636184159442:secret:james-test-WYYiCZ:GIT_TOKEN"
    DOCKER_USERNAME: "arn:aws:secretsmanager:us-east-1:636184159442:secret:james-test-WYYiCZ:DOCKER_USERNAME"
    DOCKER_PASSWORD: "arn:aws:secretsmanager:us-east-1:636184159442:secret:james-test-WYYiCZ:DOCKER_PASSWORD"


phases:
  install:
    on-failure: ABORT    

  pre_build:
    commands:
      - echo "Running Trufflehog scanning for secrets ..."      
      - docker login -u $DOCKER_USERNAME -p $DOCKER_PASSWORD
      - docker run trufflesecurity/trufflehog:latest github --repo https://github.com/Uon-Social/Backend --token $GIT_TOKEN --no-verification --json > trufflehog.log
      - echo "Trufflehog scanning complete"
      - echo "Identified Issues ..."
      - while IFS= read -r line;
        do;
          echo "$line" | jq -r '.SourceMetadata.Data.Github.link';
        done < "trufflehog.log";
          
artifacts:
  files:
    - trufflehog.json